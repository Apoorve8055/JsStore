{"version":3,"file":"instance.js","sourceRoot":"","sources":["../../../../web_worker/business/select/instance.ts"],"names":[],"mappings":"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","sourcesContent":["import { ISelect, IError } from \"../../interfaces\";\nimport { IdbHelper } from \"../idb_helper\";\nimport { Helper } from \"./helper\";\nimport { LogHelper } from \"../../log_helper\";\nimport { Util } from \"../../util\";\nimport { Error_Type } from \"../../enums\";\n\nexport class Instance extends Helper {\n\n    constructor(query: ISelect, onSuccess: (results: any[]) => void, onError: (err: IError) => void) {\n        super();\n        this._onError = onError;\n        this._onSuccess = onSuccess;\n        this._query = query;\n        this._skipRecord = query.skip;\n        this._limitRecord = query.limit;\n        this._tableName = query.from;\n    }\n\n    execute() {\n        if (this.isTableExist(this._tableName) === true) {\n            try {\n                if (this._query.where !== undefined) {\n                    this.addGreatAndLessToNotOp();\n                    this.initTransaction();\n                    if (Array.isArray(this._query.where)) {\n                        this.processWhereArrayQry();\n                    }\n                    else {\n                        this.processWhere();\n                    }\n                }\n                else {\n                    this.initTransaction();\n                    this.executeWhereUndefinedLogic();\n                }\n            }\n            catch (ex) {\n                this._errorOccured = true;\n                this.onExceptionOccured.call(this, ex, { TableName: this._query.From });\n            }\n        }\n        else {\n            this._errorOccured = true;\n            this.onErrorOccured(\n                new LogHelper(Error_Type.TableNotExist, { TableName: this._query.From }).get(),\n                true\n            );\n        }\n    }\n\n    private processWhereArrayQry() {\n        this._isArrayQry = true;\n        var is_first_where = true,\n            where_query = this._query.where,\n            output = [], operation,\n            pKey = this.getPrimaryKey(this._query.From),\n            isItemExist = (keyValue) => {\n                var is_exist = false;\n                output.every((item) => {\n                    if (item[pKey] === keyValue) {\n                        is_exist = true;\n                        return false;\n                    }\n                    return true;\n                });\n                return is_exist;\n            },\n            onSuccess = function () {\n                if (operation === 'and') {\n                    var doAnd = function () {\n                        var and_results = [];\n                        this._results.forEach((item) => {\n                            if (isItemExist(item[pKey])) {\n                                and_results.push(item);\n                            }\n                        });\n                        output = and_results;\n                        and_results = null;\n                    }.bind(this);\n                    if (output.length > 0) {\n                        doAnd();\n                    }\n                    else if (is_first_where === true) {\n                        output = this._results;\n                    }\n                    else {\n                        doAnd();\n                    }\n                }\n                else {\n                    if (output.length > 0) {\n                        this._results = output.concat(this._results);\n                        this.removeDuplicates();\n                        output = this._results;\n                    }\n                    else {\n                        output = this._results;\n                    }\n                }\n                if (where_query.length > 0) {\n                    this._results = [];\n                    processFirstQry();\n                }\n                else {\n                    this._results = output;\n                }\n                is_first_where = false;\n            }.bind(this),\n            processFirstQry = function () {\n                this._query.where = where_query.shift();\n                if (this._query.where['or']) {\n                    if (Object.keys(this._query.where).length === 1) {\n                        operation = 'or';\n                        this._query.where = this._query.where['or'];\n                        this._onWhereArrayQrySuccess = onSuccess;\n                    }\n                    else {\n                        operation = 'and';\n                        this._onWhereArrayQrySuccess = onSuccess;\n                    }\n                }\n                else {\n                    operation = 'and';\n                    this._onWhereArrayQrySuccess = onSuccess;\n                }\n                this.processWhere();\n            }.bind(this);\n        processFirstQry();\n    }\n\n    protected onQueryFinished() {\n        if (this._isOr === true) {\n            this.orQuerySuccess();\n        }\n        else if (this._isArrayQry === true) {\n            this._onWhereArrayQrySuccess();\n        }\n        else if (this._isTransaction === true) {\n            this.onTransactionCompleted();\n        }\n    }\n\n    private initTransaction() {\n        IdbHelper.createTransaction([this._tableName], this.onTransactionCompleted.bind(this), 'readonly');\n        this._objectStore = IdbHelper._transaction.objectStore(this._tableName);\n    }\n\n    private processWhere() {\n        if (this._query.where.or) {\n            this.processOrLogic();\n        }\n        this.goToWhereLogic();\n    }\n\n    private onTransactionCompleted() {\n        if (this._errorOccured === false) {\n            this.processOrderBy();\n            if (this._query.Distinct) {\n                var group_by = [];\n                var result = this._results[0];\n                for (var key in result) {\n                    group_by.push(key);\n                }\n                var primary_key = this.getPrimaryKey(this._query.From),\n                    index = group_by.indexOf(primary_key);\n                group_by.splice(index, 1);\n                this._query.GroupBy = group_by.length > 0 ? group_by : null;\n            }\n            if (this._query.GroupBy) {\n                if (this._query.Aggregate) {\n                    this.executeAggregateGroupBy();\n                }\n                else {\n                    this.processGroupBy();\n                }\n            }\n            else if (this._query.Aggregate) {\n                this.processAggregateQry();\n            }\n            this._onSuccess(this._results);\n        }\n    }\n\n    private orQueryFinish() {\n        this._isOr = false;\n        this._results = (this as any)._orInfo.Results;\n        // free or info memory\n        (this as any)._orInfo = undefined;\n        this.removeDuplicates();\n        this.onQueryFinished();\n    }\n\n    private orQuerySuccess() {\n        (this as any)._orInfo.Results = (this as any)._orInfo.Results.concat(this._results);\n        if (!this._query.Limit || (this._query.Limit > (this as any)._orInfo.Results.length)) {\n            this._results = [];\n            var key = Util.getObjectFirstKey((this as any)._orInfo.OrQuery);\n            if (key != null) {\n                var where = {};\n                where[key] = (this as any)._orInfo.OrQuery[key];\n                delete (this as any)._orInfo.OrQuery[key];\n                this._query.where = where;\n                this.goToWhereLogic();\n            }\n            else {\n                this.orQueryFinish();\n            }\n        }\n        else {\n            this.orQueryFinish();\n        }\n    }\n\n    private processOrLogic() {\n        this._isOr = true;\n        (this as any)._orInfo = {\n            OrQuery: this._query.where.or,\n            Results: []\n        };\n        // free or memory\n        delete this._query.where.or;\n    }\n}"]}